<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>주소록 목록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <style>
        .cursor-pointer { cursor: pointer; }
        .label-pill { display:inline-block; padding:.25rem .5rem; border:1px solid #dee2e6; border-radius:9999px; font-size:.75rem; margin-right:.25rem; background:#f8f9fa; }
        img.profile { width:40px; height:40px; border-radius:50%; object-fit:cover; }
        #loader, #empty { text-align:center; padding:1rem; color:#6c757d; }
    </style>
</head>
<body class="container py-4">

  <!-- 상단 컨트롤 -->
  <div class="row mb-3 align-items-center">
    <div class="col-auto">
      <label for="orderField" class="form-label mb-0 me-2">정렬:</label>
      <select class="form-select form-select-sm d-inline-block" id="orderField" style="width:auto;">
        <option value="created_at">등록일</option>
        <option value="name">이름</option>
        <option value="email">이메일</option>
        <option value="phone">전화번호</option>
      </select>
      <select class="form-select form-select-sm d-inline-block" id="orderDir" style="width:auto;">
        <option value="">오름차순</option>
        <option value="-">내림차순</option>
      </select>
    </div>
    <div class="col-auto ms-auto">
      <a class="btn btn-primary btn-sm" href="/contact/new/">추가</a>
    </div>
  </div>

  <!-- 테이블 -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col">이름</th>
          <th scope="col">이메일</th>
          <th scope="col">전화번호</th>
          <th scope="col">회사 및 직책</th>
          <th scope="col">라벨</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <!-- 상태 메시지 -->
  <div id="empty" class="d-none">데이터가 없습니다.</div>
  <div id="loader" role="status">불러오는 중…</div>
  <div id="sentinel" style="height:1px;"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
  <script>
    const BASE_API = '/api/contact/';
    const orderFieldEl = document.getElementById('orderField');
    const orderDirEl   = document.getElementById('orderDir');

    let nextUrl    = '';
    let loading    = false;
    let reachedEnd = false;

    const listEl     = document.getElementById('list');
    const loaderEl   = document.getElementById('loader');
    const emptyEl    = document.getElementById('empty');
    const sentinelEl = document.getElementById('sentinel');

    function buildApiUrl() {
        const field = orderFieldEl.value;
        const dir   = orderDirEl.value;
        const ordering = dir + field;
        return `${BASE_API}?ordering=${encodeURIComponent(ordering)}`;
    }

    function renderLabels(labels=[]) {
        return labels.map(l => `<span class="label-pill">${l.name}</span>`).join('');
    }

    async function loadMore() {
        if (loading || reachedEnd || !nextUrl) return;
        loading = true;
        loaderEl.classList.remove('d-none');

        try {
            const res = await fetch(nextUrl, { headers: { 'Accept': 'application/json' }});
            if (!res.ok) throw new Error('Network error');
            const data  = await res.json();
            const items = data.results || [];

            if (items.length === 0 && listEl.children.length === 0) {
                emptyEl.classList.remove('d-none');
            }

            const frag = document.createDocumentFragment();
            items.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'cursor-pointer';
                tr.dataset.id = c.id;
                tr.innerHTML = `
                <td>
                        <img class="profile img-thumbnail" src="${(c.profile_url) ? c.profile_url : ''}" alt="">
                        ${c.name ?? ''}
                    </td>
                    <td>${c.email ?? ''}</td>
                    <td>${c.phone ?? ''}</td>
                    <td>${c.company ?? ''} ${c.position ?? ''}</td>
                    <td>${renderLabels(c.labels)}</td>
                `;
                tr.addEventListener('click', () => { window.location.href = `/contact/${c.id}/`; });
                frag.appendChild(tr);
            });
            listEl.appendChild(frag);

            nextUrl = data.next;
            if (!nextUrl) {
                reachedEnd = true;
                loaderEl.textContent = '마지막 데이터입니다.';
            } else {
                loaderEl.classList.add('d-none');
            }
        } catch (e) {
            loaderEl.textContent = '오류가 발생했습니다.';
            console.error(e);
        } finally {
            loading = false;
        }
    }

    function resetAndLoad() {
        listEl.innerHTML = '';
        emptyEl.classList.add('d-none');
        loaderEl.textContent = '불러오는 중…';
        reachedEnd = false;
        nextUrl = buildApiUrl();
        loadMore();
    }

    orderFieldEl.addEventListener('change', resetAndLoad);
    orderDirEl.addEventListener('change', resetAndLoad);

    const io = new IntersectionObserver(entries => {
      entries.forEach(entry => entry.isIntersecting && loadMore());
    });
    io.observe(sentinelEl);

    nextUrl = buildApiUrl();
    loadMore();
</script>
</body>
</html>
